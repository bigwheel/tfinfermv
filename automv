#!/usr/bin/env ruby

require 'json'

# terraform plan -out=./plan-result
# terraform show -json plan-result > plan-result.json

$plan_file = ARGV.shift

# Refer address in https://www.terraform.io/docs/internals/json-format.html#plan-representation
class Resource
  def initialize(tree)
    @address = tree['address']
    @type = tree['type']
    @name = tree['name']

    @change = tree['change']
    @actions = tree['change']['actions'].join('-')
    @before = tree['change']['before']
    @after = tree['change']['after']
  end

  attr_reader 'type'
  attr_reader 'name'

  # https://github.com/hashicorp/terraform-json/blob/7bf4a174/action.go#L11-L26
  attr_reader 'actions'
  attr_reader 'before'
  attr_reader 'after'

  def to_s
    @address
  end

  # self must be 'delete' resource and another must be 'create' it
  def similarity(another)
    return 0.0 if @type != another.type
    compare(before, another.after)
  end

  private

  # terraform cannot distinguish nil, blank hash and blank string
  def is_blank?(obj)
    obj == nil || obj == {} || obj == ''
  end

  def compare(lhs, rhs)
    if is_blank?(lhs) && is_blank?(rhs)
      1.0
    elsif lhs.instance_of?(Hash) && rhs.instance_of?(Hash)
      compare_results = (lhs.keys & rhs.keys).
        map { |key| compare(lhs[key], rhs[key]) }
      compare_results.sum / compare_results.length
    else
      lhs == rhs ? 1.0 : 0.0
    end
  end
end


$tree = File.open($plan_file) { |file| JSON.load(file) }
resources = $tree['resource_changes'].map { |rc| Resource.new(rc) }
$creating_resources = resources.select { |r| r.actions == 'create' }
$deleting_resources = resources.select { |r| r.actions == 'delete' }

def infer_move()
  infered_moves = $deleting_resources.map do |dr|
    infered_resource = $creating_resources.find do |cr|
      dr.similarity(cr) == 1.0
    end
    if infered_resource
      [dr, infered_resource]
    else
      nil
    end
  end
  infered_moves.compact
end

# in unix manner, output under tsv
infer_move().each do |dr, cr|
  print dr, "\t", cr, "\n"
end
